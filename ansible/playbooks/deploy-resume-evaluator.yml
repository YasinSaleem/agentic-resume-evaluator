---
- name: Deploy Resume Evaluator App
  hosts: resume-evaluator
  become: yes
  vars:
    app_dir: /home/ec2-user/agentic-resume-evaluator
    branch: deployment
    backend_dir: "{{ app_dir }}/backend"
    frontend_dir: "{{ app_dir }}/frontend"
  tasks:
    - name: Ensure git is installed
      yum:
        name: git
        state: present

    - name: Ensure Node.js and Python3 are installed
      yum:
        name:
          - nodejs
          - npm
          - python3
          - python3-virtualenv
        state: present

    - name: Pull latest code
      git:
        repo: https://github.com/YasinSaleem/agentic-resume-evaluator.git
        dest: "{{ app_dir }}"
        version: "{{ branch }}"
        force: yes

    - name: Ensure pip is installed
      yum:
        name: python3-pip
        state: present

    - name: Setup backend virtualenv if not exists
      command: python3 -m virtualenv venv
      args:
        chdir: "{{ backend_dir }}"
        creates: "{{ backend_dir }}/venv"

    - name: Install backend requirements
      pip:
        requirements: "{{ backend_dir }}/requirements.txt"
        virtualenv: "{{ backend_dir }}/venv"

    - name: Install frontend dependencies
      npm:
        path: "{{ frontend_dir }}"
        production: no # Install dev dependencies as well

    - name: Clean frontend build
      file:
        path: "{{ frontend_dir }}/build"
        state: absent

    - name: Build frontend
      command: npm run build
      args:
        chdir: "{{ frontend_dir }}"
      register: build_output
      failed_when: build_output.rc != 0

    - name: Ensure PM2 is installed globally
      npm:
        name: pm2
        global: yes

    - name: Start or reload all processes via PM2 ecosystem
      command: pm2 reload ecosystem.config.js --env production
      args:
        chdir: "{{ app_dir }}"
      ignore_errors: yes

    - name: Save PM2 process list for auto-resurrection
      command: pm2 save
      args:
        chdir: "{{ app_dir }}"
